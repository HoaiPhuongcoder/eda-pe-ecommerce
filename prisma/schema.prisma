// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
  moduleFormat    = "cjs"
}

datasource db {
  provider = "postgresql"
}
model AuditLog { 
  id BigInt @id @default(autoincrement()) 
  actorId String? 
  actorType AuditActorType 
  action String 
  entity String 
  entityId String? 
  before Json? 
  after Json? 
  metadata Json? 
  createdAt DateTime @default(now())

@@index([entity, entityId])
@@index([actorId])
@@index([createdAt])

}


model Language {
  id                   String                @id @db.VarChar(10)
  name                 String                @db.VarChar(500)
  userTranslations     UserTranslation[]
  productTranslations  ProductTranslation[]
  categoryTranslations CategoryTranslation[]
  brandTranslations    BrandTranslation[]

  createdById String?
  createdBy   User? @relation("LanguageCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deletedAt])
}

model User {
  id          String     @id @default(uuid(7))
  email       String   @unique @db.VarChar(500)
  password    String  @db.VarChar(500)
  name        String?  @db.VarChar(500)
  phoneNumber String?  @unique  @db.VarChar(50)
  avatar      String? @db.VarChar(1000)

  status                      UserStatus            @default(INACTIVE)
  roleId                      Int
  role                        Role                  @relation(fields: [roleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  addresses                  UserAddress[]         @relation("UserAddress")
  orders                      Order[]
  reviews                     Review[]
  createdPermissions          Permission[]          @relation("PermissionCreatedBy")
  createdRoles                Role[]                @relation("RoleCreatedBy")
  createdProducts             Product[]             @relation("ProductCreatedBy")
  createdCategories           Category[]            @relation("CategoryCreatedBy")
  createdSKUS                 SKU[]                 @relation("SKUCreatedBy")
  createdLanguages            Language[]            @relation("LanguageCreatedBy")
  createdBrands               Brand[]               @relation("BrandCreatedBy")
  createdProductTranslations  ProductTranslation[]  @relation("ProductTranslationCreatedBy")
  createdCategoryTranslations CategoryTranslation[] @relation("CategoryTranslationCreatedBy")
  createdBrandTranslations    BrandTranslation[]    @relation("BrandTranslationCreatedBy")
  createdOrders               Order[]               @relation("OrderCreatedBy")
  soldOrders                  Order[]               @relation("Shop")
  createdUserTranslations     UserTranslation[]     @relation("UserTranslationCreatedBy")
  userTranslations            UserTranslation[]     @relation("User")
  createdDiscounts            Discount[]            @relation("DiscountCreatedBy")
  sentMessages                Message[]             @relation("FromUser")
  receivedMessages            Message[]             @relation("ToUser")

  // 1 user có thể tạo ra nhiều user khác
  // 1 user chỉ có thể được tạo ra bởi 1 user khác
  // Tự quan hệ 1-n
  createdById  String?
  createdBy    User?  @relation("CreatorUsers", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  createdUsers User[] @relation("CreatorUsers")


  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deletedAt])
}


model UserTranslation {
  id          String     @id @default(uuid(7))
  userId      String
  user        User     @relation("User", fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  languageId  String
  language    Language @relation(fields: [languageId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  address     String?  @db.VarChar(500)
  description String?

  createdById String?
  createdBy   User? @relation("UserTranslationCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  @@unique([userId, languageId])
  @@index([deletedAt])
}


model UserAddress {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation("UserAddress", fields: [userId], references: [id])

  fullName  String
  phone     String
  address   String
  ward      String?
  district  String
  city      String

  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  @@index([deletedAt])
}





model Permission {
  id          Int        @id @default(autoincrement())
  name        String     @db.VarChar(500)
  description String     @default("")
  path        String     @db.VarChar(1000)
  method      HTTPMethod
  module      String     @default("") @db.VarChar(500)
  roles       Role[]
  createdById String?
  createdBy   User? @relation("PermissionCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deletedAt])
}

model Role {
  id          Int          @id @default(autoincrement())
  name        String       @db.VarChar(500)
  description String       @default("")
  isActive    Boolean      @default(true)
  permissions Permission[]
  users       User[]

  createdById String?
  createdBy   User? @relation("RoleCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)


  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  @@unique([name])
  @@index([deletedAt])
}

model Product {
  id                  String                 @id @default(uuid(7))
  publishedAt         DateTime?
  name                String               @db.VarChar(500)
  basePrice           Decimal              @db.Decimal(10,2)
  virtualPrice        Decimal?             @db.Decimal(10,2)
  brandId             String
  brand               Brand                @relation(fields: [brandId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  images              String[]
  categories          Category[]
  ProductSlugs        ProductSlug[]
  /// [Variants]
  variants            Json
  skus                SKU[]
  reviews             Review[]
  productTranslations ProductTranslation[]
  productSKUSnapshots ProductSKUSnapshot[]

  createdById String
  createdBy   User  @relation("ProductCreatedBy", fields: [createdById], references: [id], onDelete: Cascade, onUpdate: NoAction)


  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deletedAt])
}

model ProductTranslation {
  id          String      @id @default(uuid(7))
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  languageId  String
  language    Language @relation(fields: [languageId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  name        String   @db.VarChar(500)
  description String

  createdById String?
  createdBy   User? @relation("ProductTranslationCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deletedAt])
  @@index([productId])
  @@unique([productId, languageId])
}

model ProductSlug {
  id BigInt @id @default(autoincrement())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  slug String
  isCurrent Boolean @default(true)
  createdAt DateTime @default(now())
  updateAt DateTime @updatedAt
  deletedAt DateTime? 
  
  @@unique([slug, deletedAt])
  @@index([slug])
  @@index([productId, isCurrent])
}


model Category {
  id                   String                   @id @default(uuid(7))
  products             Product[]
  name                 String                @db.VarChar(500)
  logo                 String?               @db.VarChar(1000)
  parentCategoryId     String?
  parentCategory       Category?             @relation("ParentCategoryCategories", fields: [parentCategoryId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  childrenCategories   Category[]            @relation("ParentCategoryCategories")
  categoryTranslations CategoryTranslation[]

  createdById String?
  createdBy   User? @relation("CategoryCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)


  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deletedAt])
}

model CategoryTranslation {
  id          String      @id @default(uuid(7))
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  languageId  String
  language    Language @relation(fields: [languageId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  name        String   @db.VarChar(500)
  description String

  createdById String?
  createdBy   User? @relation("CategoryTranslationCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  @@unique([categoryId, languageId])
  @@index([deletedAt])
}

model SKU {
  id                  String               @id @default(uuid(7))
  value               String               @db.VarChar(500)
  price               Decimal              @db.Decimal(10,2)
  stock               Int
  image               String
  productId           String
  product             Product              @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  productSKUSnapshots ProductSKUSnapshot[]

  createdById String
  createdBy   User  @relation("SKUCreatedBy", fields: [createdById], references: [id], onDelete: Cascade, onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deletedAt])
  @@index([productId])
}

model Brand {
  id                String                @id @default(uuid(7))
  logo              String             @db.VarChar(1000)
  products          Product[]
  brandTranslations BrandTranslation[]
  name              String             @db.VarChar(500)

  createdById String?
  createdBy   User? @relation("BrandCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)


  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deletedAt])
}

model BrandTranslation {
  id          String      @id @default(uuid(7))
  brandId     String
  brand       Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  languageId  String
  language    Language @relation(fields: [languageId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  name        String   @db.VarChar(500)
  description String

  createdById String?
  createdBy   User? @relation("BrandTranslationCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)


  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  @@unique([brandId, languageId])
  @@index([deletedAt])
}

// model CartItem {
//   id       Int  @id @default(autoincrement())
//   quantity Int
//   skuId    Int
//   sku      SKU  @relation(fields: [skuId], references: [id], onDelete: Cascade, onUpdate: NoAction)
//   userId   Int
//   user     User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt

//   @@unique([userId, skuId])
//   @@index([userId])
// }

model ProductSKUSnapshot {
  id          String    @id @default(uuid(7))
  productName String @db.VarChar(500)
  skuPrice    Decimal  @db.Decimal(10, 2)
  image       String
  skuValue    String @db.VarChar(500)
  skuId       String?
  sku         SKU?   @relation(fields: [skuId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  orderId     String?
  order       Order? @relation(fields: [orderId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  quantity            Int
  productId           String?
  product             Product? @relation(fields: [productId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  /// [ProductTranslations]
  productTranslations Json

  createdAt DateTime @default(now())
}

model Discount {
  id              String   @id @default(uuid(7)) 

  code            String   @unique @db.VarChar(50)
  name            String?  @db.VarChar(255)
  description     String?

  discountType    DiscountType
  discountValue   Decimal  @db.Decimal(10, 2)

  maxDiscount     Decimal? @db.Decimal(10, 2)
  minOrderValue   Decimal  @default(0) @db.Decimal(10, 2)

  startAt         DateTime
  endAt           DateTime

  usageLimit      Int?
  usedCount       Int      @default(0)

  status          DiscountStatus

  orders          Order[] 

  createdById     String?
  createdBy       User?    @relation("DiscountCreatedBy",fields: [createdById], references: [id], onDelete: SetNull)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  targets         DiscountTarget[]
  

  @@index([code])
  @@index([status, startAt, endAt])
}

model DiscountTarget {
  id          String              @id @default(uuid(7))
  discountId String

  targetType DiscountTargetType
  targetId   String?
  discount   Discount            @relation(fields: [discountId], references: [id], onDelete: Cascade)

  @@index([discountId])
  @@index([targetType, targetId])
}


model Order {
  id          String                  @id @default(uuid(7))
  userId      String
  user        User                 @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  status      OrderStatus
  items       ProductSKUSnapshot[]
  reviews     Review[]

  subtotal Decimal @db.Decimal(10,2)
  discountId String?
  discount   Discount?             @relation( fields: [discountId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  discountSnapshot Json
  totalAmount Decimal @db.Decimal(10,2)
  
  receiver    Json
  shopId      String?
  shop        User?                @relation("Shop", fields: [shopId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  paymentId   String
  payment     Payment              @relation(fields: [paymentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdById String?
  createdBy   User?                @relation("OrderCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)


  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([status, deletedAt])
}

model Payment {
  id        String           @id @default(uuid(7))
  orders    Order[]
  status    PaymentStatus
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}



model Review {
  id          String           @id @default(uuid(7))
  content     String
  rating      Int
  orderId     String
  order       Order         @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  productId   String
  product     Product       @relation(fields: [productId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  medias      ReviewMedia[]
  updateCount Int           @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orderId, productId])
  @@index([userId])
  @@index([productId])
}

model ReviewMedia {
  id       String       @id @default(uuid(7))
  url      String    @db.VarChar(1000)
  type     MediaType
  reviewId String
  review   Review    @relation(fields: [reviewId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  createdAt DateTime @default(now())
}

model PaymentTransaction {
  id                 String      @id @default(uuid(7))
  gateway            String   @db.VarChar(100)
  transactionDate    DateTime @default(now())
  accountNumber      String?  @db.VarChar(100)
  subAccount         String?  @db.VarChar(250)
  amountIn           Decimal @db.Decimal(18,2)      @default(0)
  amountOut          Decimal @db.Decimal(18,2)      @default(0)
  accumulated        Decimal @db.Decimal(18,2)      @default(0)
  code               String?  @db.VarChar(250)
  transactionContent String?  @db.Text
  referenceNumber    String?  @db.VarChar(255)
  body               String?  @db.Text

  createdAt DateTime @default(now())
}

model Message {
  id         String    @id @default(uuid(7))
  fromUserId String
  fromUser   User   @relation("FromUser", fields: [fromUserId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  toUserId   String
  toUser     User   @relation("ToUser", fields: [toUserId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  content    String

  readAt    DateTime?
  createdAt DateTime  @default(now())
@@index([fromUserId])
@@index([toUserId])
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum OrderStatus {
  PENDING_PAYMENT
  PENDING_PICKUP
  PENDING_DELIVERY
  DELIVERED
  RETURNED
  CANCELLED
}


enum UserStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum HTTPMethod {
  GET
  POST
  PUT
  DELETE
  PATCH
  OPTIONS
  HEAD
}

enum MediaType {
  IMAGE
  VIDEO
}
enum AuditActorType {
  USER
  ADMIN
  SYSTEM
}


enum DiscountType {
  PERCENT
  FIXED
}

enum DiscountStatus {
  ACTIVE
  INACTIVE
  EXPIRED
}

enum DiscountTargetType {
  PRODUCT
  CATEGORY
  USER
  ROLE
  ALL
}